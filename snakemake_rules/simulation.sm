#------------------------------------------------------------------------------
# Target rule for complete simulation study
#------------------------------------------------------------------------------
rule all_sim:
       input: "results/current/simulation/simulation.html"

#------------------------------------------------------------------------------
# Simulate ground truth and data for simulation study
#------------------------------------------------------------------------------
RUNS = 10
rule simulate_data:
        input:
                data=DCOHORT_DATA + "lolipop/{sentinel}.rds",
                ranges=DRANGES + "{sentinel}.rds",
                priors=DPRIORS + "{sentinel}.rds"
        output:
                DSIM_DATA + "{sentinel}.RData"
        threads: 8
        resources:
                mem_mb=1200
        params:
                sentinel="{sentinel}",
                runs=RUNS
        log:
                "logs/simulation/simulate-data/{sentinel}.log"
        benchmark:
                "benchmarks/simulation/simulate-data/{sentinel}.bmk"
        script:
                "scripts/simulate-data.R"

#------------------------------------------------------------------------------
# Apply ggm on simulated data
#------------------------------------------------------------------------------
ITERATIONS = range(1,RUNS+1)

rule apply_ggm_simulation:
        input:
                DSIM_DATA + "{sentinel}.RData",
        output:
                DSIM_FITS + "{sentinel}-iter{iteration}.RData"
        params:
                nriter=10000,
                burnin=5000,
                iteration="{iteration}"
        threads: 8
        resources:
                mem_mb=5000
        log:
                "logs/simulation/apply_ggm/{sentinel}-iter{iteration}.log"
        benchmark:
                "benchmarks/simulation/apply_ggm/{sentinel}-iter{iteration}.bmk"
        script:
                "scripts/apply-ggm-simulation.R"

#------------------------------------------------------------------------------
# Validate a simulation run
#------------------------------------------------------------------------------
rule validate_ggm_simulation:
        input:
                DSIM_FITS + "{sentinel}-iter{iteration}.RData"
        output:
                DSIM_VALIDATION + "{sentinel}-iter{iteration}.txt"
        params:
                iteration="{iteration}"
        log:
                "logs/simulation/validate_ggm/{sentinel}-iter{iteration}.log"
        script:
                "../scripts/validate-ggm-simulation.R"


#------------------------------------------------------------------------------
# Target rule to validate all simulation runs
#------------------------------------------------------------------------------
TEMP = glob_wildcards(DSIM_FITS + "{sentinel}-iter{iteration}.RData")
#rule validate_subset:
#        input: expand(DSIM_VALIDATION + "{sentinel}-iter{iter}.txt",  sentinel=TEMP.sentinel, iter=TEMP.iteration)

#rule validate_all:
#       input: expand(DSIM_VALIDATION + "{sentinel}-iter{iter}.txt", sentinel=LISTS.sentinel, iter=ITERATIONS)

#------------------------------------------------------------------------------
# Create simulation report
#------------------------------------------------------------------------------
#rule summarize_simulation:
#       input:
#               expand(DSIM_VALIDATION + "{sentinel}-iter{iter}.txt", sentinel=TEMP.sentinel, iter=TEMP.iteration)
#       output:
#               "results/current/simulation/simulation.html"
#       log:
#               "logs/simulation/summarize_simulation.log"
#       script:
#               "../scripts/summarize-simulation.Rmd"


