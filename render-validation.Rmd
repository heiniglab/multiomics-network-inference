---
title: "Validation summary"
author: "Johann Hawe"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
   rmd: "render-validation.Rmd"
output:
  html_document:
  highlight: tango
  number_sections: no
  theme: default
  toc: yes
  toc_depth: 3
  toc_float:
    collapsed: no
    smooth_scroll: yes
---

```{r echo=F}
# ------------------------------------------------------------------------------
# Load libraries and source scripts
# ------------------------------------------------------------------------------
library(ggplot2)
library(reshape2)
library(scales)
library(knitr)
library(gridExtra)
library(graph)
source("scripts/lib.R")
```

# Validation results for Bayesian GGMs calculated on KORA and LOLIPOP cohort

This document is a (graphical) summary of the results from the validation output.

## Mediation results

### Overall mediation pvalues

```{r echo=F}
# ------------------------------------------------------------------------------
# get snakemake vars
# TODO the paste command is a quick hack to avoid wdir problems
# with rmarkdown files. Follow up on this and learn the proper way
# (if any) to handle this
# ------------------------------------------------------------------------------
#fsummary <- snakemake@input[[1]]
fsummary <- "results/current/validation/validation.all.txt"

# load the large result table for all loci
# TODO we currently remove the results for the GO enrichment
tab <- read.table(fsummary, header=T, sep="\t")[1:33]
print(head(tab))

# create some basic plots of the gene counts
toplot <- tab[,c("sentinel", "cohort", "graph_type",
                 "number_nodes", "number_edges", 
                 "graph_density", "cluster", "cluster_sizes", 
                 "snp_cluster",
                 "snp_genes", "snp_genes_selected", 
                 "cpg_genes", "cpg_genes_selected", 
                 "tfs", "tfs_selected",
                 "spath", "spath_selected")]
toplot$snp_in_network <- !is.na(toplot[,"snp_cluster"])
ggplot(data=toplot, aes(snp_in_network)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) + 
  ggtitle("Number of networks in which the SNP has been selected at all")

# show the distribution of number of nodes per network
ggplot(data=toplot, aes(number_nodes)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) + 
  ggtitle("Distribution of the number of nodes in the networks")

# show the distribution of number of edges per network
ggplot(data=toplot, aes(number_edges)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) + 
  ggtitle("Distribution of the number of edges in the graph")

# show the distribution of graph_densities network
ggplot(data=toplot, aes(graph_density)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) + 
  ggtitle("Distribution of graph densities over all networks", "density= 2*|E| / |V|*(|V|-1)")

# show the distribution of resulting clusters (number of clusters, largest cluster size)
cluster_ratios <- c()
for(i in 1:nrow(toplot)) {
  # get cluster ratio
  clusters_sizes <- toplot[i,"cluster_sizes"]
  largest_cluster <- sort(as.numeric(strsplit(cluster_sizes, ",")[[1]]), decreasing = T)
  cluster_ratios <- c(cluster_ratios, 
                      largest_cluster/toplot[i,"number_nodes"])
}
toplot$cluster_ratio <- cluster_ratios

ggplot(data=toplot, aes(cluster_ratio)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) + 
  ggtitle("Ratio of the amount of nodes in the largest clusters vs all nodes in the network")

# define pseudo_count and get ratios of retained genes
pc <- 0 # no log10 for now
toplot$snp_gene_ratio <- ((toplot$snp_genes_selected + pc) / (toplot$snp_genes + pc))
toplot$cpg_gene_ratio <- ((toplot$cpg_genes_selected + pc) / (toplot$cpg_genes + pc))
toplot$tf_ratio <- ((toplot$tfs_selected + pc) / (toplot$tfs + pc))
toplot$spath_ratio <- ((toplot$spath_selected + pc) / (toplot$spath + pc))

# snp gene ratio
ggplot(data=toplot, aes(snp_gene_ratio)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) + 
  ggtitle("Ratio of the number of SNP-genes kept in GGM vs all SNP-genes in locus")
# cpg gene ratio
ggplot(data=toplot, aes(cpg_gene_ratio)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) + 
  ggtitle("Ratio of the number of CpG-genes kept in GGM vs all CpG-genes in locus")
# tf ratio
ggplot(data=toplot, aes(tf_ratio)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) + 
  ggtitle("Ratio of the number of TFs kept in GGM vs all TFs in locus")
# spath ratio
ggplot(data=toplot, aes(spath_ratio)) + geom_histogram() + 
  facet_grid(cohort ~ graph_type) +
  ggtitle("Ratio of the number of shortest path genes kept in GGM vs all shortest path genes in locus")
```

Above we see a simple overview over the selected entities (snp genes, cpg genes,
transcription factors and shortest path genes).
Shown is the log10-ratio of the number of entities selected by the GGM and the total 
number of entities in the network. Therefore, low values indicate that comparatively more genes
were dropped during the inference process and only fewer were selected for the final network.

Below the mediation results on the different cohorts for all hotspots 
in which at least one SNP gene was extracted by our algorithm are shown.
The *mediation_selected* group shows the significance of the mediation analysis of 
those selected genes, the *mediation* group shows the significance of all NOT selected genes. 
Note, that for the 'mediation_selected' group, we always take the largest obtained p-value, whereas
for the NOT selected group we always select the lowest obtained p-value as of now.


```{r echo=F}
# create a mediation specific plot
# TODO update those indices
mediation <- tab[,c("sentinel", "cohort", "graph_type",
                    "mediation", "mediation_selected","log10_mediation")]
# for now we ignore results where we didn't have SNP genes at all
mediation <- mediation[!is.infinite(mediation$log10_mediation), ,drop=F]

# plot the mediation results
toplot <- mediation[order(mediation$mediation_selected),]
toplot$sentinel <- factor(toplot$sentinel, levels=unique(toplot$sentinel))
toplot <- melt(toplot, measure.vars=c(4,5), value.name = "pval")

p <- ggplot(data=toplot, aes(x=graph_type, y=-log10(pval), fill=variable)) +
  geom_boxplot(outlier.color = NA) + 
  facet_grid(cohort ~ .) +
  theme(axis.text.x = 
          element_text(angle = 90, hjust = 1, vjust=0)) + 
  geom_hline(yintercept = -log10(0.05), color="red")
p
```

### Mediation log-foldchanges

```{r echo=F}
# in addition we plot the log fold-change
# sort by log_fc
toplot <- mediation[order(mediation$log10_mediation, decreasing = T),]
toplot$sentinel <- factor(toplot$sentinel, levels=unique(toplot$sentinel))

toplot <- melt(toplot, measure.vars=6, value.name="log_fc")
toplot$favored <- factor(sign(toplot$log_fc),labels = c("not selected", "selected"))
p <- ggplot(toplot, aes(x=sentinel, y=log_fc, fill=favored)) +
  geom_bar(stat="identity") + 
  facet_grid(cohort ~ graph_type) +
  theme(axis.text.x = 
          element_text(angle = 90, hjust = 1, vjust=0)) +
  ylab("log10(all / selected)")
p

perc <- table(toplot$favored, toplot$graph_type)
perc <- perc["selected",] / colSums(perc)
print("Percentage of selected vs not selected mediating genes:")
print(perc)

```
This figure shows a different summary of the mediation results. Shown is the log10 fold change
of the mediation p-value for the not selected SNP genes ($p_n$) over the p-value for selected
genes ($p_s$). The red bars (*not selected*) indicate fold changes where $p_n$ is lower 
than the corresponding $p_s$, whereas the blue bars indicate the opposite. Overall, 
**`r format(perc*100,digits=4)`\%** of all fold changes show negative fold changes 
(i.e. $p_s$ being smaller than their respective $p_n$s). Currently, we select the
minimal p-value obtained from the genes not selected via a GGM and the maximal p-value
from the selected genes which is a rather conservative estimate. We could think about
changing the way of summarizing the p-values...

### Percentage of mediating genes
Here we look at the percentage of significant mediation results of the GGM selected
SNP genes versus total number of SNP genes.
```{r echo=F}
# create data frame with all needed values
# TODO do this over the real validation results over all loci
results <- tab[,c("graph_type", "snp_genes", "snp_genes_selected",
                  "mediation_significant", "mediation_selected_significant")]

# handle different graph types separately
results <- split(results, f = results$graph_type)

temp <- lapply(names(results), function(n) {
  r <- results[[n]]
  # summarize results
  r <- colSums(r[,-1])
  # total amount of genes per group, selected/notselected
  sgenes.selected <- r["snp_genes_selected"]
  sgenes.notselected <- r["snp_genes"] - sgenes.selected
  # proportion of significant genes per group
  sign.selected <- r["mediation_selected_significant"] / sgenes.selected
  sign.notselected <- r["mediation_significant"] / sgenes.notselected
  
  toplot <- data.frame(selected=c(1,sign.selected), 
                       not.selected=c(1,sign.notselected))
  rownames(toplot) <- c("total tested", "proportion significant")
  
  toplot <- melt(cbind(toplot, mediation = rownames(toplot)), 
                 id.vars = c('mediation'))
  p <- ggplot(toplot, aes(x=variable,y=value, fill=mediation)) + 
    geom_bar(position="identity", stat="identity") +
    theme(axis.text.x = 
             element_text(angle = 90, hjust = 1, vjust=0)) +
    ylab("percentage of genes") +
    xlab("mediation group") +
    scale_y_continuous(labels=percent_format()) + 
    ggtitle(n)
  
  print(paste0("Difference between groups (", n, "):"))
  di <- max(sign.notselected, sign.selected) - min(sign.notselected, sign.selected)
  print(paste0(format(di,digits=2), "%"))
  
  return(p)
})
theme_update(plot.title = element_text(hjust = 0.5))
grid.arrange(temp[[1]], temp[[2]], ncol=2)

```

### Specificity and sensitivity of gene selection over all sentinels
Here we look at all sentinels and summarize the selected/not selected SNP genes and their mediation values by producing a table like the following for each sentinel and summing up over all of them:
```{r results='asis', echo=F }
temp <- matrix(c("W","X","Y","Z"),nrow=2,ncol=2)
colnames(temp) <- c("In GGM", "Not in GGM")
rownames(temp) <- c("Mediation sign","Mediation not sign")
kable(temp,align = c("c","c"))
```
```{r}
# do it for both cohorts separately for now
# we canin the endsum up the tables to get an overall view
# TODO currently we only look at the graph incl priors
cohorts <- c("kora", "lolipop")
values <- lapply(cohorts, function(cohort){
  dat <- tab[tab$cohort == cohort & tab$graph_type == "graph",
             c("sentinel", "snp_genes", "snp_genes_selected",
               "mediation_significant", "mediation_selected_significant")]
  result <- sapply(dat$sentinel, function(s) {
    d <- dat[dat$sentinel==s,,drop=F]
    v1 <- d$mediation_significant==0 & d$snp_genes_selected == 0
    v2 <- d$mediation_significant==0 & d$snp_genes_selected > 0
    v3 <- d$mediation_significant>0 & d$snp_genes_selected == 0 
    v4 <- d$mediation_selected_significant > 0
    # todo
    v5 <- ""
    return(c(v1,v2,v3,v4))  
  })
  
  result <- matrix(unlist(result), byrow = T, ncol=4)
  result <- colSums(result)
  names(result) <- c("TN", "FP", "FN", "TP")
  result
})
names(values) <- cohorts

print.perf <- function(v, msg) {
  print(msg) 
  print(paste0("Sensitivity: ", 
             v["TP"] / (v["TP"] + v["FN"])))
  print(paste0("Specificity: ", 
             v["TN"] / (v["TN"] + v["FP"])))
}

v <- values$kora
print.perf(v, "## Results for KORA:")
v <- values$lolipop
print.perf(v, "## Results for LOLIPOP:")
v <- v + values$kora[names(v)]
print.perf(v, "## Results summed over both cohorts:")

```

## CpG-Gene validation
TODO
```{r}
# TODO not yet implemented
hist(tab$bonder_cis_eQTM)
```

## Gene-Gene validation 

The gene-gene links were validated using external expression data from GEO (ARCHS4),
Geuvadis as well as the data from either LOLIPOP or KORA, depending on which cohort 
the bGGM was calculated.

To assess how well our approach recovers co-expression of genes in the independent
datasets, we calculate all gene-vs-gene (gvg) correlations in those data and create a
confusion matrix as follows:

```{r results='asis', echo=F }
temp <- matrix(c("W","X","Y","Z"),nrow=2,ncol=2)
colnames(temp) <- c("In GGM", "Not in GGM")
rownames(temp) <- c("Correlation sign.","Correlation not sign.")
kable(temp,align = c("c","c"))
```

We deem a correlation between two genes to be significant if 1) $p-value < 0.01$
and 2) $\rho > 0.3$ ($\rho$ being the Pearson Correlation Coefficient).

We test whether we can reject $H0$ (i.e. whether we detect a correlation regardless of it 
being significant in the independent data) using a Fisher's exact test.
Shown below are the p-values for those tests over all loci on the different datasets.
The black lines indicate a significance level of $0.05$.
```{r echo=F}
# get the relevant data (pvalues on the different datasets)
gg <- tab[,c("sentinel","cohort", "graph_type", "geuvadis_gene_gene","geo_gene_gene","cohort_gene_gene")]
colnames(gg) <- c("sentinel", "cohort", "graph_type", "Geuvadis", "GEO", "LOLIPOP_KORA")
#gg <- gg[order(gg$LOLIPOP_KORA),]
#gg$sentinel <- factor(gg$sentinel, levels=unique(gg$sentinel))

# plot the data
gg <- melt(gg,measure.vars=c(4,5,6), id.vars=c(1,2,3))
gg$value <- -log10(gg$value)
p <- ggplot(gg, aes(x=reorder(sentinel,value), y=value, fill=variable)) + 
  facet_grid(cohort+graph_type~variable) +
  geom_bar(stat = "identity", position="dodge") + 
  theme(axis.text.x = element_text(vjust=1, angle = 90)) + 
  xlab("sentinel") +
  geom_hline(yintercept = -log10(0.05))

p

#create list of plots
#p <- lapply(split(gg,gg$variable), function(x){
  
#  x$sentinel <- factor(x$sentinel, levels=unique(x$sentinel[order(-log10(x$value))]))

  # create the plot
#  p <- ggplot(x, aes(x = sentinel, y = -log10(value), fill = variable)) +
#    geom_bar(stat = "identity") +
#    facet_grid(cohort~.) +
#    theme(legend.position="none", axis.text.x = element_text(vjust=1, angle = 90)) + 
#    geom_hline(yintercept = -log10(0.05)) +
#    labs(title=unique(x$variable))
#})

#do.call(grid.arrange,(c(p, nrow=3)))
```


