---
title: "Preprocess cohort data"
output: html_notebook
---

```{r}
library(pheatmap)
library(GenomicRanges)
```


```{r}
# parse the sentinels from the available data files
files <- list.files("data/current/cohorts/", ".*.KORA.adjusted.data.RData", full.names = F)
sentinels <- unlist(lapply(sapply(files, strsplit, "\\."), "[[", 1))
# get data for both cohorts for all sentinels
cohorts <- c("kora", "lolipop")

# for plotting the expression plots
plot.dir <- "results/current/plots/expression_per_sentinel"
if(!dir.exists(plot.dir)){
  dir.create(plot.dir, recursive = T)
}
data <- lapply(sentinels, function(sentinel){
  cat(sentinel, "\n")
  d <- lapply(cohorts, function(co){
    # load data into new environment
    env <- new.env()
    dfile <- paste0("data/current/cohorts/", 
                    sentinel, ".", toupper(co), ".adjusted.data.RData")
    if(!file.exists(dfile)){
      warning(paste0(co, " data does not exist for sentinel ", sentinel, "."))
    } else {
      load(dfile, envir=env)
      ggm.data <- with(env, processed)
      nodes <- colnames(ggm.data)
      # adjust ranges for only those which were initially found in the data
      load(paste0("data/current/cohorts/", 
                  sentinel, ".ranges.RData"))
      ranges$cpg.genes <- ranges$cpg.genes[(ranges$cpg.genes$SYMBOL) %in% nodes]
      ranges$snp.genes <- ranges$snp.genes[(ranges$snp.genes$SYMBOL) %in% nodes]
      ranges$spath <- ranges$spath[ranges$spath$SYMBOL %in% nodes]
      ranges$tfs <- ranges$tfs[ranges$tfs$SYMBOL %in% nodes]
      return(list(id=id, data=ggm.data, ranges=ranges, nodes=nodes))
    }
  })
  names(d) <- cohorts
  return(d)
})
names(data) <- sentinels
save(file="results/current/data.processed.RData", data)
```

We create the expression correlation plots for each sentinel for easier
diagnostics.
```{r}
hmps <- unlist(lapply(names(data), function(sentinel){
  print(sentinel)
  d <- data[[sentinel]]
  lapply(cohorts, function(co){
    expr.data <- d[[co]]$data[,!grepl("^rs|^cg", d[[co]]$nodes)]
    cor.mat <- cor((expr.data))
    mean.cor <- mean(cor.mat)
    if(mean.cor >= 0.05){
      cat(sentinel, "\t", co, "\t", mean.cor, "\n")
    }
    # plot gene expression correlations
    pdf(paste0(plot.dir, "/", co, ".", sentinel,".pdf"))
    pheatmap(cor.mat)
    dev.off()
  })
}))
```
